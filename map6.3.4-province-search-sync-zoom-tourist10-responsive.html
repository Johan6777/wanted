<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß + Dashboard + ‡∏Å‡∏£‡∏≤‡∏ü + ‡∏ï‡∏≤‡∏£‡∏≤‡∏á</title>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
document.getElementById('agencyInput').addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    filterData();
  }
});

const originalFilterData = filterData;
filterData = function() {
  const agencyText = (document.getElementById('agencyInput').value || '').toLowerCase();
  const startInput = document.getElementById('startDate').value;
  const endInput = document.getElementById('endDate').value;

  const filtered = allData.filter(row => {
    const agency = (row['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'] || '').toLowerCase();
    const matchAgency = agency.includes(agencyText);
    let matchDate = true;
    if (startInput && endInput) {
      const date = new Date(convertThaiDateToISO(row['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']));
      const start = new Date(startInput);
      const end = new Date(endInput);
      matchDate = date >= start && date <= end;
    }
    return matchAgency && matchDate;
  });

  renderMarkers(filtered);
  updateDashboard(filtered);
};

const originalResetAll = resetAll;
resetAll = function() {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('agencyInput').value = '';
  renderMarkers(allData);
  updateDashboard(allData);
  map.flyTo([13.736717, 100.523186], 6, { animate: true, duration: 2 });
}

</script>
<style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #container { display: flex; height: 100vh; }
    #dashboard { width: 300px; background: #f4f4f4; padding: 10px; overflow-y: auto; box-shadow: 2px 0 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
    #map { flex: 1; }
    #charts { width: 300px; background: #f9f9f9; padding: 10px; overflow-y: auto; box-shadow: -2px 0 8px rgba(0,0,0,0.1); }
    .card { background: white; padding: 20px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: center; }
    .card h2 { margin: 0; color: #007bff; }
    .card p { margin: 5px 0 0 0; font-size: 14px; color: #333; }
    input[type="text"], input[type="date"], button { width: 100%; margin-top: 5px; padding: 8px; }
    button { background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    canvas { width: 100% !important; height: auto !important; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    tr:hover { background-color: #e9f5ff; cursor: pointer; }
    .leaflet-tooltip.my-tooltip {
      background: rgba(255, 255, 255, 0.8);
      color: #333;
      font-weight: bold;
      border: 1px solid #999;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    @media (max-width: 768px) { #container { flex-direction: column; } #dashboard, #charts { width: 100%; height: auto; } }
  
@media (max-width: 1024px) {
  #container {
    flex-direction: column;
  }
  #dashboard, #charts {
    width: 100%;
    height: auto;
    box-shadow: none;
  }
  #dashboard button, #dashboard input[type="text"], #dashboard input[type="date"] {
    font-size: 16px;
  }
  canvas {
    max-width: 100% !important;
    height: auto !important;
  }
  #map {
    min-height: 400px;
  }
}
</style>
<style>
  input::placeholder {
    color: #aaa;
    font-size: 16px;
  }
</style>
</head>
<body>
<div id="container">
<div id="dashboard">
<div class="card"><h2 id="visitCount">0</h2><p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p></div>
<div class="card"><h2 id="placeCount">0</h2><p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p></div>
<input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" style="display:block; width: 100%; margin-top: 0px; padding: 8px; font-size: 16px; 
            color: #333; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;" type="text"/>
<input id="agencyInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" style="display:block; width: 100%; margin-top: 5px; padding: 8px; font-size: 16px; 
            color: #333; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;" type="text"/>
<input id="startDate" type="date"/>
<input id="endDate" type="date"/>
<button onclick="filterData()">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<button onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
<button onclick="toggleBaseMap()">‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
<div id="tableContainer"></div>
</div>
<div id="map"></div>
<div id="charts">
<h2 style="text-align:center">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏†‡∏±‡∏¢‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏°</h2>
<canvas id="threatChart"></canvas>
<style>
      #threatChart {
        max-width: 250px;  /* üëà ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
        max-height: 250px; /* üëà ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
        margin: 0 auto;    /* üëà ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        display: block;
      }
      </style>
<br/>
<br/>
<h2 style="text-align:center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</h2>
<canvas id="touristChart"></canvas>
<br/>
<br/>
<h2 style="text-align:center">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h2>
<div id="provinceTableContainer">
<table id="provinceTable" style="width:100%; border-collapse: collapse;">
<thead>
<tr style="background:#f0f0f0;">
<th style="padding:6px; border:1px solid #ccc;">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
<th style="padding:6px; border:1px solid #ccc;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<br/>
<br/>
<div style="white-space:nowrap; overflow:hidden; box-sizing:border-box;"><span style="display:inline-block; padding-left:100%; animation:marquee 10s linear infinite;">Power by..‡∏ô‡∏≤‡∏¢‡∏Å‡∏≠‡∏á ‡∏î‡∏¥‡∏ô‡∏î‡∏≥ TEEWASIT LEMNUI Div5-SB2</span></div><style>@keyframes marquee{0%{transform:translateX(0);}100%{transform:translateX(-100%);}}</style>
</div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
document.getElementById('agencyInput').addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    filterData();
  }
});

const originalFilterData = filterData;
filterData = function() {
  const agencyText = (document.getElementById('agencyInput').value || '').toLowerCase();
  const startInput = document.getElementById('startDate').value;
  const endInput = document.getElementById('endDate').value;

  const filtered = allData.filter(row => {
    const agency = (row['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'] || '').toLowerCase();
    const matchAgency = agency.includes(agencyText);
    let matchDate = true;
    if (startInput && endInput) {
      const date = new Date(convertThaiDateToISO(row['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']));
      const start = new Date(startInput);
      const end = new Date(endInput);
      matchDate = date >= start && date <= end;
    }
    return matchAgency && matchDate;
  });

  renderMarkers(filtered);
  updateDashboard(filtered);
};

const originalResetAll = resetAll;
resetAll = function() {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('agencyInput').value = '';
  renderMarkers(allData);
  updateDashboard(allData);
  map.flyTo([13.736717, 100.523186], 6, { animate: true, duration: 2 });
}

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
document.getElementById('agencyInput').addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    filterData();
  }
});

const originalFilterData = filterData;
filterData = function() {
  const agencyText = (document.getElementById('agencyInput').value || '').toLowerCase();
  const startInput = document.getElementById('startDate').value;
  const endInput = document.getElementById('endDate').value;

  const filtered = allData.filter(row => {
    const agency = (row['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'] || '').toLowerCase();
    const matchAgency = agency.includes(agencyText);
    let matchDate = true;
    if (startInput && endInput) {
      const date = new Date(convertThaiDateToISO(row['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']));
      const start = new Date(startInput);
      const end = new Date(endInput);
      matchDate = date >= start && date <= end;
    }
    return matchAgency && matchDate;
  });

  renderMarkers(filtered);
  updateDashboard(filtered);
};

const originalResetAll = resetAll;
resetAll = function() {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('agencyInput').value = '';
  renderMarkers(allData);
  updateDashboard(allData);
  map.flyTo([13.736717, 100.523186], 6, { animate: true, duration: 2 });
}

</script>
<script>
// ‚úÖ ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (77 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
const provinceCenters = {
  "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£":[13.7278956,100.524123499999],
"‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà":[8.0862997,98.9062834999999],
"‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ":[14.0227797,99.5328114999999],
"‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå":[16.4314078,103.5058755],
"‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£":[16.4827798,99.5226617999999],
"‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô":[16.4419355,102.8359921],
"‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ":[12.61134,102.103854599999],
"‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤":[13.6904194,101.077959599999],
"‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ":[13.3611431,100.9846717],
"‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó":[15.1851971,100.125125],
"‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥":[15.8068173,102.0315027],
"‡∏ä‡∏∏‡∏°‡∏û‡∏£":[10.4930496,99.1800198999999],
"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢":[19.9071656,99.830955],
"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà":[18.7877477,98.9931311],
"‡∏ï‡∏£‡∏±‡∏á":[7.5593851,99.6110065],
"‡∏ï‡∏£‡∏≤‡∏î":[12.2427563,102.517473399999],
"‡∏ï‡∏≤‡∏Å":[16.8839901,99.1258497999999],
"‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å":[14.2069466,101.2130511],
"‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°":[13.8199206,100.0621676],
"‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°":[17.392039,104.769550799999],
"‡∏ô‡∏Ñ‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤":[14.9798997,102.097769299999],
"‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä":[8.4303975,99.9631219],
"‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå":[15.6930072,100.122559499999],
"‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø":[13.8621125,100.514352799999],
"‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™":[6.4254607,101.825314299999],
"‡∏ô‡πà‡∏≤‡∏ô":[18.7756318,100.7730417],
"‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå":[14.9930017,103.1029191],
"‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ":[14.0208391,100.525027599999],
"‡∏õ‡∏£‡∏∞‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå":[11.812367,99.7973270999999],
"‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ":[14.0509704,101.372743899999],
"‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ":[6.86948439999999,101.250482599999],
"‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤":[14.3532128,100.568959899999],
"‡∏û‡∏∞‡πÄ‡∏¢‡∏≤":[19.1664789,99.9019419],
"‡∏û‡∏±‡∏á‡∏á‡∏≤":[8.4407456,98.5193031999999],
"‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á":[7.6166823,100.074023099999],
"‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£":[16.4429516,100.348232899999],
"‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å":[16.8298048,100.2614915],
"‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ":[13.1111601,99.9391306999999],
"‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå":[16.4189807,101.155092599999],
"‡πÅ‡∏û‡∏£‡πà":[18.1445774,100.1402831],
"‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï":[7.9810496,98.3638823999999],
"‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°":[16.1850896,103.302646099999],
"‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£":[16.542443,104.720915099999],
"‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô":[19.2990643,97.9656225999999],
"‡∏¢‡πÇ‡∏™‡∏ò‡∏£":[15.792641,104.1452827],
"‡∏¢‡∏∞‡∏•‡∏≤":[6.541147,101.280394699999],
"‡∏£‡πâ‡∏≠‡∏¢":[16.0538196,103.652003599999],
"‡∏£‡∏∞‡∏ô‡∏≠‡∏á":[9.9528702,98.6084640999999],
"‡∏£‡∏∞‡∏¢‡∏≠‡∏á":[12.6833115,101.237429499999],
"‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ":[13.5282893,99.8134211],
"‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ":[14.7995081,100.6533706],
"‡∏•‡∏≥‡∏õ‡∏≤‡∏á":[18.2888404,99.4908739999999],
"‡∏•‡∏≥‡∏û‡∏π‡∏ô":[18.5744606,99.0087221],
"‡πÄ‡∏•‡∏¢":[17.4860232,101.7223002],
"‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©":[15.1186009,104.322009499999],
"‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£":[17.1545995,104.1348365],
"‡∏™‡∏ß‡∏µ‡πÄ‡∏î‡∏ô":[7.1756004,100.614346999999],
"‡∏™‡∏ï‡∏π‡∏•":[6.6238158,100.0673744],
"‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£":[13.5990961,100.5998319],
"‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°":[13.4098217,100.0022645],
"‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£":[13.5475216,100.274395599999],
"‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß":[13.824038,102.0645839],
"‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ö‡∏∏‡∏£‡∏µ":[14.5289154,100.9101421],
"‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ":[14.8936253,100.3967314],
"‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢":[17.0055573,99.8263712],
"‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ":[14.4744892,100.117712799999],
"‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ":[9.1382389,99.3217482999999],
"‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå":[14.882905,103.4937107],
"‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢":[17.8782803,102.7412638],
"‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π":[17.2218247,102.4260368],
"‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á":[14.5896054,100.455052],
"‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç":[15.8656783,104.6257774],
"‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ":[17.4138413,102.7872325],
"‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå":[17.6200886,100.0992942],
"‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ":[15.3835001,100.024552699999],
"‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ":[15.2286861,104.8564217],
"‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨":[18.3609104,103.646446299999]
// ... ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
};

function convertThaiDateToISO(dateStr) {
  if (!dateStr) return '';
  const [d, m, y] = dateStr.split('/').map(Number);
  return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
}
function formatISOToThaiDate(isoStr) {
  if (!isoStr) return '';
  const [y, m, d] = isoStr.split('-');
  return `${parseInt(d)}/${parseInt(m)}/${y}`;
}

// ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
const map = L.map('map').setView([13.736717, 100.523186], 6);
let street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
let currentBase = 'street';
let markersLayer = L.layerGroup().addTo(map);
let allData = [];
let allMarkers = [];
let threatChart, touristChart, provinceChart;

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
fetch('https://opensheet.elk.sh/1K-ofsr0X8WA0wr633VjULu8wSojs_pFSQJhez2ASCnI/data_map')
.then(res => res.json())
.then(data => { allData = data; renderMarkers(allData); updateDashboard(allData); })
.catch(err => console.error('Error loading data', err));

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
function renderMarkers(data) {
  markersLayer.clearLayers();
  allMarkers = [];
  const grouped = {};
  data.forEach(row => {
    const place = row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'] || '';
    if (!grouped[place]) grouped[place] = [];
    grouped[place].push(row);
  });

  Object.entries(grouped).forEach(([place, rows]) => {
    const latest = rows[0];
    const loc = latest['‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'];
    if (loc && loc.includes(",")) {
      const [lat, lng] = loc.split(",").map(Number);
      const province = latest['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || '';
      const assessBefore = latest['‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á'] || '';

      const history = rows.sort((a, b) => {
        const d1 = new Date(convertThaiDateToISO(b['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']) + 'T' + b['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']);
        const d2 = new Date(convertThaiDateToISO(a['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']) + 'T' + a['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']);
        return d2 - d1;
      }).map(r => `<div><b style='color:#cc0000;'>${r['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']} ${r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']}</b><br>${r['‡∏™‡∏ñ‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏ì‡∏∞‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']}</div>`).join('<hr>');

      const popupContent = `
        <div style="text-align: left; line-height: 1.5; max-height: 300px; overflow-y: auto;">
          <b style="color:#004080;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> ${place}<br>
          <b style="color:#004080;">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</b> ${province}<br>
          <b style="color:#004080;">‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${loc}<br>
          <b style="color:#004080;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</b> ${rows.length}<br>
          <b style="color:#004080;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</b> ${latest['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'] || '-'}<br>
          <b style="color:#004080;">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á:</b> ${latest['‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á'] || '-'}<br>
          <b style="color:#004080;">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏•‡∏á:</b> ${latest['‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏•‡∏á'] || '-'}<br><br>
          
<b style="color:#004080;">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</b><br>
${rows.sort((a, b) => {
  const t1 = new Date(`${convertThaiDateToISO(b['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà'])}T${b['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà'] || '00:00'}`).getTime();
  const t2 = new Date(`${convertThaiDateToISO(a['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà'])}T${a['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà'] || '00:00'}`).getTime();
  return t1 - t2;
}).map(r => `
  <div style="margin-bottom:10px;">
    <span style="color:#cc0000;"><b>${r['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']} ${r['‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']}</b></span><br>
    <b style="color:#004080;">‡∏™‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ:</b> ${r['‡∏™‡∏ñ‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏ì‡∏∞‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà'] || '-'}<br>
    <b style="color:#004080;">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏±‡∏¢‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏°:</b> ${r['‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏±‡∏¢‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏° ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà'] || '-'}<br>
    <hr>
  </div>
`).join('')}

        </div>
      `;
      const marker = L.circleMarker([lat, lng], {
        radius: 6,
        fillColor: assessBefore === '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß' ? 'green' : assessBefore === '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á' ? 'yellow' : assessBefore === '‡πÅ‡∏î‡∏á' ? 'red' : 'blue',
        color: '#333', weight: 1, opacity: 1, fillOpacity: 0.8
      }).bindPopup(popupContent);
      marker.bindTooltip(place, { permanent: false, direction: 'top', className: 'my-tooltip' });
      marker.place = place.toLowerCase();
      marker.province = province.toLowerCase();
      marker.threat = assessBefore;
      marker.addTo(markersLayer);
      allMarkers.push(marker);
      marker.on('click', () => {
        const filtered = allData.filter(r => (r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'] || '').toLowerCase() === marker.place);
        updateDashboard(filtered);
      });
    }
  });
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
function toggleBaseMap() { if (currentBase === 'street') { map.removeLayer(street); satellite.addTo(map); currentBase = 'satellite'; } else { map.removeLayer(satellite); street.addTo(map); currentBase = 'street'; }}
function resetAll() {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('searchInput').value = '';
  renderMarkers(allData);
  updateDashboard(allData);
  map.flyTo([13.736717, 100.523186], 6, { animate: true, duration: 2 });
}
function filterData() {
  const startInput = document.getElementById('startDate').value;
  const endInput = document.getElementById('endDate').value;
  if (!startInput || !endInput) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
  const start = new Date(startInput);
  const end = new Date(endInput);
  const filtered = allData.filter(row => {
    const date = new Date(convertThaiDateToISO(row['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']));
    return date >= start && date <= end;
  });
  renderMarkers(filtered);
  updateDashboard(filtered);
}
function updateDashboard(data) {
  if (threatChart) threatChart.destroy();
  if (touristChart) touristChart.destroy();
  if (provinceChart) provinceChart.destroy();
  const threatCounts = { ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: 0, ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: 0, ‡πÅ‡∏î‡∏á: 0, '‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô': 0 };
  const touristDates = {};
  const provinceCounts = {};
  data.forEach(row => {
    const assess = row['‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á'];
    if (assess && threatCounts[assess] !== undefined) { threatCounts[assess]++; } else if (!assess) { threatCounts['‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô']++; }
    const isoDate = convertThaiDateToISO(row['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']);
    const count = parseInt(row['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏Ç‡∏ì‡∏∞‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']) || 0;
    if (!touristDates[isoDate]) touristDates[isoDate] = 0;
    touristDates[isoDate] += count;
    const province = row['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'];
    if (!provinceCounts[province]) provinceCounts[province] = 0;
    provinceCounts[province]++;
  });
  threatChart = new Chart(document.getElementById('threatChart'), {
    type: 'pie',
    data: { labels: ['‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', '‡πÅ‡∏î‡∏á', '‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'], datasets: [{ data: [threatCounts['‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß'], threatCounts['‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á'], threatCounts['‡πÅ‡∏î‡∏á'], threatCounts['‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô']], backgroundColor: ['green', 'yellow', 'red', 'blue'] }] },
    options: { onClick: (e, elements) => { if (elements.length > 0) { const clicked = elements[0].index; 
const label = threatChart.data.labels[clicked];
let color = '';
if (label === '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß') color = 'green';
else if (label === '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á') color = 'yellow';
else if (label === '‡πÅ‡∏î‡∏á') color = 'red';
else color = 'blue';
 filterMarkersByThreat(color); } }}
  });
  const sortedDates = Object.keys(touristDates).sort((a, b) => new Date(a) - new Date(b));
  const latest10 = sortedDates.slice(-10);
  const chartLabels = latest10.map(d => formatISOToThaiDate(d));
  const chartData = latest10.map(d => touristDates[d]);

  touristChart = new Chart(document.getElementById('touristChart'), {
    type: 'line',
    data: {
      labels: chartLabels,
      datasets: [{
        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß',
        data: chartData,
        borderColor: 'blue',
        backgroundColor: 'blue',
        fill: false
      }]
    }
  });
  provinceChart = new Chart(document.getElementById('provinceChart'), {
    type: 'bar',
    data: { labels: Object.keys(provinceCounts), datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', data: Object.values(provinceCounts), backgroundColor: 'orange' }] }
  });
  document.getElementById('visitCount').innerText = data.length;
  document.getElementById('placeCount').innerText = new Set(data.map(r => r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'])).size;
  renderTable(data);
  renderProvinceTable(data);
}
function renderTable(data) {
  const tableContainer = document.getElementById('tableContainer');
  tableContainer.innerHTML = '';
  const placeCounts = {};
  data.forEach(row => { const place = row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; placeCounts[place] = (placeCounts[place] || 0) + 1; });
  const sortedPlaces = Object.entries(placeCounts).sort((a, b) => b[1] - a[1]);
  let html = '<table><thead><tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th></tr></thead><tbody>';
  sortedPlaces.forEach(([place, count]) => {
    html += `<tr onclick="filterByPlace('${place}')"><td>${place}</td><td>${count}</td></tr>`;
  });
  html += '</tbody></table>';
  tableContainer.innerHTML = html;
}
function filterByPlace(placeName) {
  const filtered = allData.filter(row => (row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'] || '').toLowerCase().includes(placeName.toLowerCase()));
  renderMarkers(filtered);
  updateDashboard(filtered);
  const marker = allMarkers.find(m => m.place.includes(placeName.toLowerCase()));
  if (marker) { map.flyTo(marker.getLatLng(), 14, { animate: true, duration: 1.5 }); marker.openPopup(); }
}
function filterMarkersByThreat(color) {
  const filteredData = allData.filter(row => {
    const assess = row['‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏á'];
    
if (color === 'blue') {
  return !assess || assess === '' || assess === '-' || assess === '‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
}
return assess && (
  (color === 'green' && assess === '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß') ||
  (color === 'yellow' && assess === '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á') ||
  (color === 'red' && assess === '‡πÅ‡∏î‡∏á')
);

  });
  renderMarkers(filteredData);
  updateDashboard(filteredData);
}
document.getElementById('searchInput').addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    const search = this.value.trim().toLowerCase();
    if (!search) return;
    let found = false;
    allMarkers.forEach(marker => {
      if (marker.place.includes(search) || marker.province.includes(search)) {
        map.flyTo(marker.getLatLng(), 14, { animate: true, duration: 1.5 });
        marker.openPopup();
        found = true;
      }
    });
    if (!found) {
      for (const [provinceName, center] of Object.entries(provinceCenters)) {
        if (provinceName.toLowerCase().includes(search)) {
          const lat = center[0], lng = center[1];
          const bounds = L.latLngBounds([lat - 0.5, lng - 0.5], [lat + 0.5, lng + 0.5]);
          map.fitBounds(bounds, { animate: true, duration: 2 });
          found = true;
          break;
        }
      }
    }
    
if (!found) {
  const filtered = allData.filter(row => (row['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || '').toLowerCase().includes(search));
  if (filtered.length > 0) {
    renderMarkers(filtered);
    updateDashboard(filtered);
    const first = filtered[0];
    const province = first['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'];
    if (province && provinceCenters[province]) {
      const center = provinceCenters[province];
      map.flyTo(center, 10, { animate: true, duration: 1.5 });
    }
  } else {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
  }
}

  }
});

document.getElementById('agencyInput').addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    filterData();
  }
});

const originalFilterData = filterData;
filterData = function() {
  const agencyText = (document.getElementById('agencyInput').value || '').toLowerCase();
  const startInput = document.getElementById('startDate').value;
  const endInput = document.getElementById('endDate').value;

  const filtered = allData.filter(row => {
    const agency = (row['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'] || '').toLowerCase();
    const matchAgency = agency.includes(agencyText);
    let matchDate = true;
    if (startInput && endInput) {
      const date = new Date(convertThaiDateToISO(row['‡∏ß‡∏î‡∏õ.‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà']));
      const start = new Date(startInput);
      const end = new Date(endInput);
      matchDate = date >= start && date <= end;
    }
    return matchAgency && matchDate;
  });

  renderMarkers(filtered);
  updateDashboard(filtered);
};

const originalResetAll = resetAll;
resetAll = function() {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('agencyInput').value = '';
  renderMarkers(allData);
  updateDashboard(allData);
  map.flyTo([13.736717, 100.523186], 6, { animate: true, duration: 2 });
}




function renderProvinceTable(data) {
  const provinceCounts = {};
  data.forEach(row => {
    const province = row['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    if (!provinceCounts[province]) provinceCounts[province] = 0;
    provinceCounts[province]++;
  });

  const sorted = Object.entries(provinceCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  const tbody = document.querySelector("#provinceTable tbody");
  tbody.innerHTML = '';
  sorted.forEach(([province, count]) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="padding:6px; border:1px solid #ccc; cursor:pointer; color:#007bff;">${province}</td>
      <td style="padding:6px; border:1px solid #ccc;">${count}</td>`;
    row.querySelector("td").addEventListener("click", () => {
      const filtered = allData.filter(r => (r['‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'] || '').toLowerCase() === province.toLowerCase());
      renderMarkers(filtered);
      updateDashboard(filtered);
      if (provinceCenters[province]) {
        const [lat, lng] = provinceCenters[province];
        map.flyTo([lat, lng], 10, { animate: true, duration: 1.5 });
      }
    });
    tbody.appendChild(row);
  });
}
</script>
</body>
</html>
